---
import type { Product, ProductCategory } from "../data/products";
import { Image } from "astro:assets";

type Category = { name: string };

interface Props {
  categories: Category[];
  productsByCategory: ProductCategory[];
}

const { categories, productsByCategory } = Astro.props as Props;
---

<section
  class="px-2 sm:px-4 mt-2 sm:mt-4 max-w-2xl mx-auto"
  x-data="{
    modalOpen: false,
    modalName: '',
    modalInfo: '',
    modalPrice: '',
    modalImage: '',
    openModal(e) {
      const el = e.currentTarget;
      this.modalName = el.dataset.name;
      this.modalInfo = el.dataset.info;
      this.modalPrice = el.dataset.price;
      this.modalImage = el.dataset.image;
      this.modalOpen = true;
    },
    closeModal() {
      this.modalOpen = false;
    }
  }"
  @close-modal.window="closeModal()"
>
  <h2 class="text-base sm:text-lg font-semibold mb-2 text-center">
    Categorías
  </h2>
  <div
    id="cat-filtros"
    class="flex gap-2 overflow-x-auto pb-2 mb-4 scrollbar-hide"
  >
    <button
      type="button"
      class="px-3 py-1 rounded-full border text-sm whitespace-nowrap bg-secondary text-black font-bold"
      data-cat="Todos"
    >
      Todos
    </button>
    {
      categories.map((cat: Category) => (
        <button
          type="button"
          class="px-3 py-1 rounded-full border text-sm whitespace-nowrap bg-gray-100 text-gray-700"
          data-cat={cat.name}
        >
          {cat.name}
        </button>
      ))
    }
  </div>
  <div id="cat-productos">
    {
      productsByCategory.map((cat: ProductCategory) => (
        <div class="mb-8 cat-group" data-cat={cat.category}>
          <h3 class="text-xl font-bold mb-4 text-center text-primary border-b-2 border-secondary pb-2">{cat.category}</h3>
          <div class="space-y-4">
            {cat.products.map((prod: Product) => (
              <div
                class="bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-xl cursor-pointer transition-all duration-300 hover:scale-[1.02] border border-gray-100"
                @click="openModal($event)"
                data-name={prod.name}
                data-info={prod.info}
                data-price={prod.price}
                data-image={
                  typeof prod.image === "object" && prod.image.src
                    ? prod.image.src
                    : prod.image
                }
              >
                <div class="flex">
                  <div class="w-24 h-24 sm:w-32 sm:h-32 md:w-40 md:h-40 flex-shrink-0">
                    <Image
                      src={prod.image}
                      alt={prod.name}
                      class="w-full h-full object-cover rounded-l-xl"
                      widths={[200, 400]}
                      height={160}
                      sizes="(max-width: 640px) 96px, (max-width: 768px) 128px, 160px"
                      loading="lazy"
                    />
                  </div>
                  <div class="flex-1 p-3 sm:p-4 flex flex-col justify-between">
                    <div>
                      <h4 class="font-bold text-base sm:text-lg md:text-xl text-gray-800 mb-1 sm:mb-2 leading-tight">{prod.name}</h4>
                      <p class="text-gray-600 text-xs sm:text-sm md:text-base mb-2 sm:mb-3 line-clamp-2">
                        {prod.info}
                      </p>
                    </div>
                    <div class="flex items-center justify-between gap-2">
                      <p class="text-secondary font-bold text-lg sm:text-xl md:text-2xl">
                        ${prod.price.toFixed(2)}
                      </p>
                      <button
                        class="bg-primary hover:bg-primary/90 text-white px-2 py-1 sm:px-3 sm:py-2 rounded-full text-xs sm:text-sm font-medium transition-all duration-200 hover:scale-105 add-to-cart-btn flex items-center gap-1"
                        data-product-name={prod.name}
                        data-product-price={prod.price}
                        data-product-info={prod.info}
                        data-product-image={
                          typeof prod.image === "object" && prod.image.src
                            ? prod.image.src
                            : prod.image
                        }
                        onclick="event.stopPropagation(); addToCart(this)"
                      >
                        <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        <span class="hidden sm:inline">Carrito</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      ))
    }
  </div>
  <!-- Modal inline controlado por Alpine.js -->
  <div
    x-show="modalOpen"
    x-transition.opacity.duration.200ms
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-2"
    @click.self="closeModal()"
    style="backdrop-filter: blur(2px);"
  >
    <div
      class="bg-white rounded-lg shadow-lg w-full max-w-xs sm:max-w-sm relative"
    >
      <button
        class="absolute top-2 right-2 text-gray-500 hover:text-black text-2xl font-bold"
        @click="closeModal()"
        aria-label="Cerrar">×</button
      >
      <img
        :src="modalImage.startsWith('/src/assets') || modalImage.startsWith('/public') || modalImage.startsWith('/') ? modalImage : '/src/assets/' + modalImage"
        :alt="modalName + ' [' + modalImage + ']'"
        class="w-full h-40 sm:h-48 object-contain bg-white rounded-t-lg flex items-center justify-center"
        style="object-fit:contain;"
        @error="console.log('No se pudo cargar la imagen:', modalImage)"
      />
      <div class="p-3 sm:p-4">
        <h2
          class="text-lg sm:text-xl font-bold mb-2 text-center"
          x-text="modalName"
        >
        </h2>
        <p
          class="text-gray-600 text-sm sm:text-base mb-2 text-center"
          x-text="modalInfo"
        >
        </p>
        <p
          class="text-secondary font-bold text-base sm:text-lg mb-2 text-center"
        >
          $<span x-text="Number(modalPrice).toFixed(2)"></span>
        </p>
      </div>
    </div>
  </div>
</section>

<script is:inline>
  const filtroBtns = document.querySelectorAll("#cat-filtros button[data-cat]");
  const grupos = document.querySelectorAll(".cat-group");
  filtroBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const cat = btn.getAttribute("data-cat");
      filtroBtns.forEach((b) =>
        b.classList.remove("bg-secondary", "text-black", "font-bold")
      );
      btn.classList.add("bg-secondary", "text-black", "font-bold");
      if (cat === "Todos") {
        grupos.forEach((g) => (g.style.display = ""));
      } else {
        grupos.forEach((g) => {
          if (g.getAttribute("data-cat") === cat) {
            g.style.display = "";
          } else {
            g.style.display = "none";
          }
        });
      }
    });
  });

  // Función para agregar productos al carrito
  function addToCart(button) {
    const product = {
      name: button.dataset.productName,
      price: parseFloat(button.dataset.productPrice),
      info: button.dataset.productInfo,
      image: button.dataset.productImage
    };
    
    // Usar el cartManager si está disponible
    if (window.cartManager) {
      window.cartManager.addItem(product);
    } else {
      // Fallback: esperar a que se cargue el cartManager
      setTimeout(() => {
        if (window.cartManager) {
          window.cartManager.addItem(product);
        }
      }, 100);
    }
  }

  // Hacer la función disponible globalmente
  window.addToCart = addToCart;
</script>
